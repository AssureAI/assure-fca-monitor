<!-- templates/admin_test.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assure – Admin Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    h1 { font-size: 28px; margin: 0 0 6px 0; }
    .sub { color: #555; margin-bottom: 18px; }
    .card { background: white; border: 1px solid #ddd; border-radius: 10px; padding: 16px; margin-bottom: 16px; }

    label { display:block; font-weight: 700; margin-top: 10px; }
    select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
    textarea { min-height: 220px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    button { background: #111827; color: white; border: 0; padding: 10px 14px; border-radius: 10px; font-weight: 800; cursor: pointer; margin-top: 12px; }
    button:hover { opacity: 0.92; }

    hr { border: 0; border-top: 1px solid #ddd; margin: 18px 0; }

    .pill { display:inline-block; padding: 3px 10px; border-radius: 999px; background: #eee; font-size: 12px; margin-left: 6px; }
    .ok { color: #0a7a2f; font-weight: 900; }
    .pi { color: #b45309; font-weight: 900; }
    .na { color: #6b7280; font-weight: 900; }

    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; font-size: 13px; }
    th { background: #fafafa; text-align: left; }

    details summary { cursor: pointer; font-weight: 800; }
    ul { margin: 8px 0 0 18px; }
    .muted { color: #6b7280; font-size: 12px; }
    .why { color: #374151; font-size: 12px; margin-top: 6px; white-space: pre-wrap; }
    .kv { display:flex; gap:10px; flex-wrap:wrap; margin-top:6px; }
    .kv code { background:#f3f4f6; border:1px solid #e5e7eb; padding:2px 6px; border-radius:8px; font-size:12px; }

    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }

    pre { background:#0b1020; color:#e5e7eb; padding:12px; border-radius:10px; overflow:auto; font-size:12px; }
  </style>
</head>
<body>
  <h1>Assure – Admin Test</h1>
  <div class="sub">Deterministic check. Evidence is capped snippets (no full SR echo). This view is built for debugging.</div>

  <div class="card" id="input">
    <details {% if not result %}open{% endif %}>
      <summary>{% if result %}Edit inputs{% else %}Inputs{% endif %}</summary>

      <form method="post" action="/admin/test">
        <label for="advice_type">Advice type</label>
        <select name="advice_type" id="advice_type">
          <option value="advised" {% if advice_type == "advised" %}selected{% endif %}>advised</option>
          <option value="nonadvised" {% if advice_type == "nonadvised" %}selected{% endif %}>nonadvised</option>
          <option value="execution_only" {% if advice_type == "execution_only" %}selected{% endif %}>execution_only</option>
        </select>

        <label for="investment_element">Investment element</label>
        <select name="investment_element" id="investment_element">
          <option value="true" {% if investment_element == "true" %}selected{% endif %}>true</option>
          <option value="false" {% if investment_element == "false" %}selected{% endif %}>false</option>
        </select>

        <label for="ongoing_service">Ongoing service</label>
        <select name="ongoing_service" id="ongoing_service">
          <option value="false" {% if ongoing_service == "false" %}selected{% endif %}>false</option>
          <option value="true" {% if ongoing_service == "true" %}selected{% endif %}>true</option>
        </select>

        <label for="sr_text">Suitability Report text</label>
        <textarea name="sr_text" id="sr_text" placeholder="Paste SR text here...">{{ sr_text or "" }}</textarea>

        <button type="submit">Run check</button>
      </form>
    </details>
  </div>

  {% if result %}
    <div id="results" class="card">
      <h2 style="margin:0 0 10px 0;">Results</h2>

      <div class="muted">
        <div><b>Ruleset:</b> {{ result.get("ruleset_id", "") }} v{{ result.get("ruleset_version", "") }}</div>
        <div><b>Checked at:</b> {{ result.get("checked_at", "") }}</div>
        <div><b>Rules file used:</b> <code>{{ result.get("rules_path_used", "") }}</code></div>
        {% if run_id %}
          <div><b>Saved run:</b> <a href="/admin/runs/{{ run_id }}">Open run</a></div>
        {% endif %}
      </div>

      {% set summary = result.get("summary", {}) %}
      <div style="margin-top:10px;">
        <b>Summary:</b>
        <span class="pill">ok: {{ summary.get("ok", 0) }}</span>
        <span class="pill">potential_issue: {{ summary.get("potential_issue", 0) }}</span>
        <span class="pill">not_assessed: {{ summary.get("not_assessed", 0) }}</span>
      </div>

      <hr/>

      <details>
        <summary>Raw JSON (debug)</summary>
        <pre>{{ result | tojson(indent=2) }}</pre>
      </details>

      <hr/>

      {% set sections = result.get("sections", {}) %}
      {% for sname, rules in sections.items() %}
        {% set okc = rules | selectattr("status", "equalto", "OK") | list | length %}
        {% set pic = rules | selectattr("status", "equalto", "POTENTIAL_ISSUE") | list | length %}
        {% set nac = rules | selectattr("status", "equalto", "NOT_ASSESSED") | list | length %}

        <details open style="margin-bottom:14px;">
          <summary>
            {{ sname }}
            <span class="pill">OK: {{ okc }}</span>
            <span class="pill">PI: {{ pic }}</span>
            <span class="pill">NA: {{ nac }}</span>
          </summary>

          <div style="margin-top:10px;">
            <table>
              <thead>
                <tr>
                  <th style="width: 24%;">Rule</th>
                  <th style="width: 12%;">Status</th>
                  <th style="width: 22%;">Citation</th>
                  <th>Evidence & Debug</th>
                </tr>
              </thead>
              <tbody>
                {% for r in rules %}
                  <tr>
                    <td>
                      <div><b>{{ r.get("rule_id") }}</b></div>
                      <div class="muted">{{ r.get("title", "") }}</div>
                    </td>

                    <td>
                      {% if r.get("status") == "OK" %}
                        <span class="ok">OK</span>
                      {% elif r.get("status") == "POTENTIAL_ISSUE" %}
                        <span class="pi">POTENTIAL_ISSUE</span>
                      {% else %}
                        <span class="na">NOT_ASSESSED</span>
                      {% endif %}
                    </td>

                    <td>
                      <div>{{ r.get("citation", "") }}</div>
                      {% if r.get("source_url") %}
                        <div><a href="{{ r.get('source_url') }}" target="_blank" rel="noopener">Source</a></div>
                      {% endif %}
                    </td>

                    <td>
                      {% set ev = r.get("evidence", []) %}
                      {% set why = r.get("why", "") %}
                      {% set missing = r.get("missing", []) %}
                      {% set details_list = r.get("details", []) %}
                      {% set counts = r.get("counts", {}) %}
                      {% set eby = r.get("evidence_by_key", {}) %}

                      <details>
                        <summary>Open</summary>

                        <div class="why"><b>Why:</b> {{ why if why else "No reason provided." }}</div>

                        {% if counts and counts|length > 0 %}
                          <div class="why" style="margin-top:8px;"><b>Counts:</b></div>
                          <div class="kv">
                            {% for k, v in counts.items() %}
                              <code>{{ k }}={{ v }}</code>
                            {% endfor %}
                          </div>
                        {% endif %}

                        {% if missing and missing|length > 0 %}
                          <div class="why" style="margin-top:10px;"><b>Missing:</b></div>
                          <ul>
                            {% for m in missing %}
                              <li>{{ m }}</li>
                            {% endfor %}
                          </ul>
                        {% endif %}

                        {% if details_list and details_list|length > 0 %}
                          <div class="why" style="margin-top:10px;"><b>Details:</b></div>
                          <ul>
                            {% for d in details_list %}
                              <li>{{ d }}</li>
                            {% endfor %}
                          </ul>
                        {% endif %}

                        <div class="why" style="margin-top:10px;"><b>Evidence (top-level):</b></div>
                        {% if ev and (ev | length) > 0 %}
                          <ul>
                            {% for e in ev %}
                              <li>{{ e }}</li>
                            {% endfor %}
                          </ul>
                        {% else %}
                          <div class="muted">No matching snippets found.</div>
                        {% endif %}

                        {% if eby and eby|length > 0 %}
                          <div class="why" style="margin-top:10px;"><b>Evidence by signal bucket:</b></div>
                          {% for k, lst in eby.items() %}
                            <details style="margin-top:6px;">
                              <summary>{{ k }} ({{ lst|length }})</summary>
                              {% if lst and lst|length > 0 %}
                                <ul>
                                  {% for x in lst %}
                                    <li>{{ x }}</li>
                                  {% endfor %}
                                </ul>
                              {% else %}
                                <div class="muted">No snippets for this bucket.</div>
                              {% endif %}
                            </details>
                          {% endfor %}
                        {% endif %}

                      </details>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      {% endfor %}

      <div style="margin-top:10px;">
        <a href="/admin/test">Run again</a>
        {% if run_id %}
          &nbsp;·&nbsp;<a href="/admin/runs/{{ run_id }}">Open saved run</a>
          &nbsp;·&nbsp;<a href="/admin/runs">Run history</a>
        {% else %}
          &nbsp;·&nbsp;<a href="/admin/runs">Run history</a>
        {% endif %}
      </div>
    </div>

    <script>
      (function () {
        const el = document.getElementById("results");
        if (el) el.scrollIntoView({ behavior: "smooth", block: "start" });
      })();
    </script>
  {% endif %}
</body>
</html>
